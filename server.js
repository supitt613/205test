require('dotenv').config();const express = require('express');const cors = require('cors');const axios = require('axios');const { createClient } = require('@supabase/supabase-js');const app = express();const PORT = process.env.PORT || 3000;const LINE_NOTIFY_TOKEN = process.env.LINE_NOTIFY_TOKEN;const SUPABASE_URL = process.env.SUPABASE_URL;const SUPABASE_KEY = process.env.SUPABASE_KEY;if (!LINE_NOTIFY_TOKEN) { console.error('LINE_NOTIFY_TOKEN is not set in .env file.'); process.exit(1);}if (!SUPABASE_URL || !SUPABASE_KEY) { console.warn('Supabase URL or Key is not set in .env file. Session logging will be skipped.');}const supabase = SUPABASE_URL && SUPABASE_KEY ? createClient(SUPABASE_URL, SUPABASE_KEY) : null;app.use(cors());app.use(express.json());app.use(express.static('public'));app.post('/notify', async (req, res) => { const { message, duration_minutes } = req.body; if (!message) { return res.status(400).json({ error: 'Message is required.' }); } const lineNotifyUrl = 'https://notify-api.line.me/api/notify'; try { // 1. Send Line Notification await axios.post(lineNotifyUrl, new URLSearchParams({ message: message }).toString(), { headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': `Bearer ${LINE_NOTIFY_TOKEN}` } }); // 2. Log session to Supabase if Supabase client is initialized if (supabase) { const { data, error } = await supabase .from('study_sessions') .insert([ { start_time: new Date().toISOString(), duration_minutes: duration_minutes || 23, notified: true } ]); if (error) { console.error('Error logging session to Supabase:', error); // Continue even if logging fails, notification is primary } else { console.log('Session logged to Supabase:', data); } } res.status(200).json({ message: 'Notification sent and session logged successfully.' }); } catch (error) { console.error('Error during Line notification or Supabase logging:', error.response ? error.response.data : error.message); res.status(500).json({ error: 'Failed to send notification or log session.', details: error.response ? error.response.data : error.message }); }});app.listen(PORT, () => { console.log(`Server running on http://localhost:${PORT}`); console.log('Frontend available at http://localhost:3000');});